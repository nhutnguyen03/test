CREATE TABLE Users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role ENUM('Quản lý', 'Ca sáng', 'Ca chiều') NOT NULL
);
CREATE TABLE Shifts (
    shift_id INT AUTO_INCREMENT PRIMARY KEY,
    shift_name VARCHAR(20) NOT NULL,  -- Dễ dàng thêm ca mới
    start_time TIME NOT NULL,
    end_time TIME NOT NULL
);
CREATE TABLE Tables (
    table_id VARCHAR(10) PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL
);
CREATE TABLE Categories (
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    status ENUM('Hoạt động', 'Không hoạt động') DEFAULT 'Hoạt động'
);
CREATE TABLE Products (
    product_id INT AUTO_INCREMENT PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    category_id INT NOT NULL,
    size ENUM('Nhỏ', 'Vừa', 'Lớn') NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    status ENUM('Hoạt động', 'Ngừng bán') DEFAULT 'Hoạt động',
    FOREIGN KEY (category_id) REFERENCES Categories(category_id)
);
CREATE TABLE Promotions (
    promo_id INT AUTO_INCREMENT PRIMARY KEY,
    discount_code VARCHAR(50) UNIQUE NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status ENUM('Hoạt động', 'Hết hạn') DEFAULT 'Hoạt động'
);
CREATE TABLE Orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    table_id VARCHAR(10) NOT NULL,
    shift_id INT NOT NULL,
    promo_id INT DEFAULT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    order_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Chờ chế biến', 'Hoàn thành', 'Đã thanh toán', 'Đã hủy') DEFAULT 'Chờ chế biến',
    notes TEXT,
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (table_id) REFERENCES Tables(table_id),
    FOREIGN KEY (shift_id) REFERENCES Shifts(shift_id),
    FOREIGN KEY (promo_id) REFERENCES Promotions(promo_id)
);
CREATE TABLE Order_Details (
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, product_id),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE CASCADE
);
CREATE TABLE Payments (
    payment_id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    payment_method ENUM('Tiền mặt', 'Chuyển khoản', 'Thẻ', 'MoMo') NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    transaction_code VARCHAR(50) NULL,
    status ENUM('Thành công', 'Thất bại', 'Chờ xử lý') DEFAULT 'Chờ xử lý',
    FOREIGN KEY (order_id) REFERENCES Orders(order_id)
);
CREATE TABLE Suppliers (
    supplier_id INT AUTO_INCREMENT PRIMARY KEY,
    supplier_name VARCHAR(100) NOT NULL,
    contact_person VARCHAR(100),
    phone VARCHAR(15),
    email VARCHAR(100),
    address TEXT,
    status ENUM('Hoạt động', 'Ngừng hợp tác') DEFAULT 'Hoạt động'
);
CREATE TABLE Materials (
    material_id INT AUTO_INCREMENT PRIMARY KEY,
    material_name VARCHAR(100) NOT NULL,
    supplier_id INT NOT NULL,
    unit VARCHAR(50) NOT NULL,
    stock_quantity INT NOT NULL,
    status ENUM('Còn hàng', 'Hết hàng') DEFAULT 'Còn hàng',
    FOREIGN KEY (supplier_id) REFERENCES Suppliers(supplier_id)
);
CREATE TABLE Stock_Entries (
    entry_id INT AUTO_INCREMENT PRIMARY KEY,
    supplier_id INT NOT NULL,
    material_id INT NOT NULL,
    quantity INT NOT NULL,
    cost_price DECIMAL(10,2) NOT NULL,
    total_cost DECIMAL(10,2) GENERATED ALWAYS AS (quantity * cost_price) STORED,
    entry_datetime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (supplier_id) REFERENCES Suppliers(supplier_id),
    FOREIGN KEY (material_id) REFERENCES Materials(material_id)
);
CREATE TABLE Stock_Usages (
    usage_id INT AUTO_INCREMENT PRIMARY KEY,
    material_id INT NOT NULL,
    quantity_used INT NOT NULL,
    shift_id INT NOT NULL,  -- Ghi nhận theo ca làm việc
    usage_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    note TEXT, -- Ghi chú (VD: hao hụt, hủy bỏ...)
    FOREIGN KEY (material_id) REFERENCES Materials(material_id),
    FOREIGN KEY (shift_id) REFERENCES Shifts(shift_id)
);
CREATE TABLE Revenue_Reports (
    report_id INT AUTO_INCREMENT PRIMARY KEY,
    shift_id INT NOT NULL,
    total_revenue DECIMAL(10,2) NOT NULL,
    total_orders INT NOT NULL,
    report_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (shift_id) REFERENCES Shifts(shift_id)
);
CREATE TABLE Profit_Reports (
    report_id INT AUTO_INCREMENT PRIMARY KEY,
    month INT NOT NULL,
    year INT NOT NULL,
    total_revenue DECIMAL(10,2) NOT NULL,
    total_cost DECIMAL(10,2) NOT NULL,
    total_orders INT NOT NULL DEFAULT 0,
    net_profit DECIMAL(10,2) GENERATED ALWAYS AS (total_revenue - total_cost) STORED,
    UNIQUE (month, year)  -- Đảm bảo mỗi tháng chỉ có 1 báo cáo lợi nhuận
);
INSERT INTO Users (username, password, role) VALUES
('S01', '123456', 'Ca sáng'),
('C01', '123456', 'Ca chiều'),
('quanly1', 'admin123', 'Quản lý');
INSERT INTO Shifts (shift_name, start_time, end_time) VALUES
('Ca sáng', '07:00:00', '14:00:00'),
('Ca chiều', '14:00:00', '22:00:00');
INSERT INTO Tables (table_id, table_name, table_type, status) VALUES
-- Bàn trong nhà
('TNH1', 'Bàn trong nhà 1', 'Trong nhà', 'Trống'),
('TNH2', 'Bàn trong nhà 2', 'Trong nhà', 'Trống'),
('TNH3', 'Bàn trong nhà 3', 'Trong nhà', 'Trống'),
-- Bàn ngoài trời
('NT1', 'Bàn ngoài trời 1', 'Ngoài trời', 'Trống'),
('NT2', 'Bàn ngoài trời 2', 'Ngoài trời', 'Trống'),
-- Mang về
('MV1', 'Mang về 1', 'Mang về', 'Trống'),
('MV2', 'Mang về 2', 'Mang về', 'Trống');
INSERT INTO Categories (category_id, category_name, status) VALUES
(1, 'Trà', 'Hoạt động'),
(2, 'Cà phê', 'Hoạt động'),
(3, 'Bánh', 'Hoạt động'),
(4, 'Khác', 'Hoạt động');
INSERT INTO Products (product_name, category_id, size, price, status) VALUES
-- Danh mục Trà (category_id = 1)
('Trà sen vàng', 1, 'Nhỏ', 25000, 'Hoạt động'),
('Trà sen vàng', 1, 'Vừa', 30000, 'Hoạt động'),
('Trà sen vàng', 1, 'Lớn', 35000, 'Hoạt động'),
-- Danh mục Cà phê (category_id = 2)
('Cà phê đen', 2, 'Nhỏ', 20000, 'Hoạt động'),
('Cà phê đen', 2, 'Vừa', 25000, 'Hoạt động'),
('Cà phê đen', 2, 'Lớn', 30000, 'Hoạt động'),
('Cà phê sữa', 2, 'Nhỏ', 25000, 'Hoạt động'),
('Cà phê sữa', 2, 'Vừa', 30000, 'Hoạt động'),
('Cà phê sữa', 2, 'Lớn', 35000, 'Hoạt động'),
-- Danh mục Bánh (category_id = 3)
('Bánh chuối', 3, 'Vừa', 15000, 'Hoạt động'),
('Bánh cookies', 3, 'Vừa', 20000, 'Hoạt động'),
-- Danh mục Khác (category_id = 4)
('Nước suối', 4, 'Vừa', 10000, 'Hoạt động'),
('Coca', 4, 'Vừa', 15000, 'Hoạt động'),
('Topping (Trân châu)', 4, 'Nhỏ', 5000, 'Hoạt động'),
('Topping (Thạch)', 4, 'Nhỏ', 5000, 'Hoạt động');
-- Cập nhật bảng Orders
ALTER TABLE Orders
ADD COLUMN completed BOOLEAN DEFAULT FALSE;

-- Cập nhật bảng Payments
ALTER TABLE Payments
ADD COLUMN payment_time DATETIME DEFAULT CURRENT_TIMESTAMP;

-- Cập nhật bảng Order_Details
ALTER TABLE Order_Details
ADD COLUMN note TEXT;